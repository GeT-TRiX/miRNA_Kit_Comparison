---
title: "Kit_Venndiagram_1_19_18"
author: "Carrie Wright"
date: "1/19/2018"
output: html_document
---

load the data
```{r, eval=TRUE, echo=FALSE}
library(edgeR)
library(here)

Pheno<-read.table(here("Complete_data/Pheno.txt"), header = TRUE)
miR_counts<-read.table(here("/Complete_data/miR.Counts.csv"), header = TRUE, sep = ",")

rownames(miR_counts)<- miR_counts$miRNA#make miRNA rownames
miR_counts<-miR_counts[,2:length(colnames(miR_counts))]#remove miRNA col

colnames(miR_counts)<-gsub("directional_dedupped|directional_deduped", "Deduped", colnames(miR_counts))
colnames(miR_counts)<-gsub("NEXT_", "NEXTflex_", colnames(miR_counts))
miRNAtotal<-t(miR_counts[1,])#extract the total miRNA counts... in case we want them
miR_counts<-miR_counts[-1,]#remove total miRNA counts row

Pheno$File<-gsub("NEXTflex_deduped", "Deduped", Pheno$File)
Pheno$Kit<-gsub("NEXTflex_deduped", "Deduped", Pheno$Kit)
Pheno$TriplicateGroup<-gsub("NEXTflex_deduped", "Deduped", Pheno$TriplicateGroup)
Pheno$miRNAtotal <-miRNAtotal
divide_by_18<-lapply(miR_counts, function(x) {x/18})
get_greaterthan65536 <-function(x){x[which(x>65536), drop = FALSE]}
greater_vals <-list()
greater_vals <- lapply(miR_counts, get_greaterthan65536)
perc_greater <-lapply(greater_vals, function(x){((x-65536)/x)*100})
num_greater<-t(data.frame(lapply(greater_vals, length)))
###remove 2nd batch files
miR_counts<-miR_counts[-grep("Accur", Pheno$Batch)]
Pheno<- Pheno[-grep("Accur", Pheno$Batch),]
miRNAtotal<- miRNAtotal[-grep("Accur", Pheno$Batch)]


library("RBioinf")
# randUMI<-lapply(rep(8,65536), randDNA)
# randUMI2<-data.frame(lapply(rep(8,65536), randDNA))
# UMIs <-(data.frame(unlist(randUMI)))
# length(unique(UMIs$unlist.randUMI.))  #this means that without repeats each miRNA has a chance of being expressed roughly 41,481 times before amplification because some UMIs will be randomly repeated...but how many UMIs are there actually in the soln???? its much more than 65536 - that is just what is unique...
# raw_nextflex <- miR_counts[which(Pheno$Kit =="NEXTflex")]
# total_nextflex <- Pheno$miRNAtotal[which(Pheno$Kit =="NEXTflex"),]
# top <-lapply(raw_nextflex, max)
# top<-data.frame(unlist(top))
# (top/total_nextflex)*100
```
Functions
```{r}

library(compute.es)
get_test_names <- function(data){
  test_names <<- data.frame(combn(unique(names(data)), m= 2))
}

get_test_results<- function(data,test_names, pairedvalue) {
  tresults<<-list()
  tested_names1<<-list()
  tested_names2<<-list()
  length_kits <<-list()
  for(i in names(test_names)){
    Kit1 <-data[which(names(data) %in% test_names[i][1,])]
    Kit2 <-data[which(names(data) %in% test_names[i][2,])]
    tested_names1[[i]]<<-names(data)[names(data) %in% test_names[i][1,]]
    tested_names2[[i]]<<-names(data)[names(data) %in% test_names[i][2,]]
    tresults[[i]]<<-t.test(x=Kit1[[1]], y=Kit2[[1]], paired = pairedvalue)
    tested_kits <<-paste0(tested_names1, "&", tested_names2)
    length_kits[[i]]<<-c(length(Kit1[[1]]), length(Kit2[[1]]))
  }
}

get_ttestStats<- function(x, tested_kits) {
  c(t =format(x$statistic, digits = 2),
    df = format(x$parameter, digits = 0),
    p.value = format(x$p.value, scientific = TRUE, digits = 2),
    bonferroni.threshold = format(.05/length(test_names), digits = 2),
    sig = ifelse(x$p.value<(.05/length(test_names)), "yes", "no"),
    mean_1st_method = format(x$estimate[[1]], digits =2), 
    mean_2nd_method =format(x$estimate[[2]], digits =2))
}

get_t.es.g <- function(ts){
  t.es.g <<-list()
  for(i in names(length_kits)){
  t.es.g[[i]]<<-tes(ts[[i]]$statistic, n.1 = length_kits[i][[1]][1], n.2 = length_kits[i][[1]][2])$g
  }
}


```


###DESeq2
```{r, eval=TRUE,warning=FALSE, message=FALSE, echo =FALSE}
library(DESeq2)
#miR_counts<- miR_counts[-c(1:18, 58:93)]
#Pheno <- Pheno[-c(1:18, 68:93),]
# miR_counts<- miR_counts[,c(19:57)]
# Pheno <- Pheno[c(19:57),]
dds<-DESeqDataSetFromMatrix(countData = miR_counts, colData = Pheno, design = ~ Kit)
dds <- estimateSizeFactors(dds)
norm_miR_counts<-data.frame(counts(dds, normalized = TRUE))
dim(norm_miR_counts)

#greater_vals <- lapply(norm_miR_counts, get_greaterthan65536)
#num_greater<-t(data.frame(lapply(greater_vals, length)))

# get_thresh_number <-function(x){length(which(x>10))}
# lapply(norm_miR_counts, get_thresh_number)
# lapply(miR_counts, get_thresh_number)

```



Simple detection >10 reads for each sample
```{r}
library(ggplot2)
##filter each sample individually
get_det <-function(x){sum(x>10)}#determine number of miRNAs with greater than 10 reads
detected <-lapply(norm_miR_counts, get_det)
detected <-data.frame(unlist(detected))
det_Data <- cbind(detected, Pheno$startingAmt, Pheno$Kit)
colnames(det_Data)<- c("det_indv_thresh", "startingAmt", "kit")
```


filter across triplicates for starting amounts
```{r}
library(genefilter)
library(reshape2)
library(dplyr)
library(sjstats)

#first by kit and amount
Pheno$startingAmt <-factor(Pheno$startingAmt)
split_kit_miRNAData <- list()
for(i in unique(Pheno$startingAmt)) {
  for(kit in unique(Pheno$Kit)){
  split_kit_miRNAData[[i]][[kit]] <- data.frame(norm_miR_counts[which(Pheno$startingAmt == as.character(i) & Pheno$Kit == as.character(kit))])}
}

#filter across triplicates for each kit/amount
poverafun <- genefilter::pOverA(p = 1, A = 10)#at least 100 normalized reads in all samples of the set... 
ffun <- filterfun(poverafun)
genefilt_fun<- function(x){genefilter(x, ffun)}

thresh <-list()
for(amt in names(split_kit_miRNAData)){
thresh[[amt]]<-lapply(split_kit_miRNAData[[as.character(amt)]], genefilt_fun)} #lapply across the kits for given amount to filter the triplicates

#split by amount and kit and actually take the threshold determined from just above
split_amt_thresh <-list()
for(amt in names(split_kit_miRNAData)){
for(kit in names(split_kit_miRNAData[[amt]])){
 split_amt_thresh[[amt]][[kit]]<- split_kit_miRNAData[[amt]][[kit]][thresh[[amt]][[kit]],]}
}



#just get the number detected
thresh_number <- list()
for(amt in names(split_kit_miRNAData)){
for(kit in names(split_kit_miRNAData[[amt]])){
thresh_number[[amt]][[kit]]<- dim(split_kit_miRNAData[[amt]][[kit]][thresh[[amt]][[kit]],])[1]}
}

#rearrange the number detected across data
thresh_number_df <-data.frame(thresh_number)
colnames(thresh_number_df) <-c("100", "250", "500", "1000", "1500", "2000")
thresh_number_df$kit <- rownames(thresh_number_df)
thresh_number_df <-melt(thresh_number_df)
thresh_number_df$variable <-as.numeric(as.character(thresh_number_df$variable))
thresh_number_df<-thresh_number_df[-which(thresh_number_df$value =="0"),]
thresh_number_df$kit <- factor(thresh_number_df$kit,levels = c("Clontech", "Illumina", "NEB", "NEXTflex", "Deduped", "Fivepercent"))
#save(split_amt_thresh, Pheno, file =here("Complete_data/one_batch_thresh10across_trip.rda"))
thresh_number_df$variable<-factor(thresh_number_df$variable)


pdf(file =here("Supplement/Figures/bar_miRNA_across_thresh_all_amounts.pdf"),width=3.8,height=4, onefile=FALSE)
ggplot(thresh_number_df, aes(x =variable, y = value), fill = "kit") +geom_bar(color = "black", stat = "identity", position = "dodge",aes(y =value, fill = kit))+coord_cartesian(ylim=c(250,600)) +theme(legend.position = "none", axis.text.x = element_text(size =17, angle = 60, hjust = 1), axis.text.y = element_text(size =15, hjust = 1), axis.title=element_text(size = 20), plot.title = element_text(size = 30), strip.text.x = element_text(size = 20)) + labs( x= "Starting Amount", y = " Unique miRNAs", title = "miRNA Detection Across Kits")
dev.off()

pdf(file =here("Supplement/Figures/boxplot_miRNA_across_thresh_all_amounts_together.pdf"),width=3.8,height=4, onefile=FALSE)
ggplot(thresh_number_df, aes(x =kit, y = value), fill = "kit") +geom_boxplot(color = "black",aes(y =value, fill = kit))+coord_cartesian(ylim=c(250,600))+geom_jitter(width =0.2) +theme(legend.position = "none", axis.text.x = element_text(size =17, angle = 60, hjust = 1), axis.text.y = element_text(size =15, hjust = 1), axis.title.y=element_text(size = 20), axis.title.x=element_text(size = 0), plot.title = element_text(size = 30), strip.text.x = element_text(size = 20)) + labs(y = " Unique miRNAs", title = "miRNA Detection Across Kits")
dev.off()

pdf(file =here("Supplement/Figures/line_graph_miRNA_Det_across_thresh_all_amounts.pdf"),width=10,height=6)
ggplot(thresh_number_df, aes(x =variable, y=value, fill = kit)) + geom_point(aes(color = kit, cex = 2)) + facet_grid(.~kit) + theme(legend.position = "none", axis.text.x = element_text(size =17, angle = 60, hjust = 1), axis.text.y = element_text(size =15, hjust = 1), axis.title=element_text(size = 20), plot.title = element_text(size = 20, face = "bold"), strip.text.x = element_text(size = 20)) + labs( x= "Starting Amount", y = " Detected miRNA Sequences", title = " miRNA Detection >10 reads in all triplicates") +geom_smooth(method = "loess", se=TRUE, aes(group=1, color = kit))
dev.off()

anova(lm(thresh_number_df$value~ thresh_number_df$kit))
anova_stats(anova(lm(thresh_number_df$value~ thresh_number_df$kit)))
thresh_number_kits <-split(x=thresh_number_df$value, f = thresh_number_df$kit)

get_test_names(thresh_number_kits)
get_test_results(thresh_number_kits, test_names = test_names, pairedvalue = FALSE)
ttestStats_across<-data.frame(lapply(tresults, get_ttestStats, tested_kits = tested_kits))
colnames(ttestStats_across)<-tested_kits
t(ttestStats_across) #lower t indicates lower error across triplicates
get_t.es.g(ts = tresults)
 t(data.frame(t.es.g))
 

Means<-unlist(lapply(thresh_number_kits, mean))
test_names<-names(Means)
get_perc_diff <-function(data) {
  percresults<<-list()
  tested_names1<<-list()
  tested_names2<<-list()
  tested_kits<<-list()
  for(i in names(test_names)){
    percresults[[i]]<<-((data[ which(names(data)==test_names[i][1,])]-data[ which(names(data)==test_names[i][2,])]))/ data[ which(names(data)==test_names[i][2,])]*100
    tested_names1[[i]]<<-test_names[i][1,]
    tested_names2[[i]]<<-test_names[i][2,]
    tested_kits[[i]] <<-paste0(tested_names1[[i]], "&", tested_names2[[i]])
    }
}
get_test_names(Means)
get_perc_diff(data = Means)
perc_stats<-data.frame(percresults)
colnames(perc_stats)<-tested_kits
t(perc_stats)

#detection diversity loss with lower inputs?
thresh_number_df$variable<- as.numeric(as.character(thresh_number_df$variable))
summary(lm(thresh_number_df$value~ thresh_number_df$variable))
cor.test(thresh_number_df$value, thresh_number_df$variable)

split_thresh_number_df<-split(thresh_number_df, thresh_number_df$kit)
get_cor <-function(x){cor.test(x$value, x$variable)}
lapply(split_thresh_number_df, get_cor)
```


Why does clontech have similar detection despite low mapping? - is it the normalization?????


```{r}

 Means_counts <- lapply(split_amt_thresh$`1000`, rowMeans)
lapply(Means_counts, range)
 get_num_less_than_100 <- function(x){length(which(x<100))}
 lapply(Means_counts,get_num_less_than_100)



Clontech_top <- data.frame(rownames(data.frame(Means_counts$Clontech[order(-rank(Means_counts$Clontech))]))[1:10])
Illumina_top <- data.frame(rownames(data.frame(Means_counts$Illumina[order(-rank(Means_counts$Illumina))]))[1:10])
NEB_top <- data.frame(rownames(data.frame(Means_counts$NEB[order(-rank(Means_counts$NEB))]))[1:10])
NEXTflex_top <- data.frame(rownames(data.frame(Means_counts$NEXTflex[order(-rank(Means_counts$NEXTflex))]))[1:10])
Deduped_top <- data.frame(rownames(data.frame(Means_counts$Deduped[order(-rank(Means_counts$Deduped))]))[1:10])
Fivepercent_top <- data.frame(rownames(data.frame(Means_counts$Fivepercent[order(-rank(Means_counts$Fivepercent))]))[1:10])


Clontech_top <- data.frame(rownames(data.frame(Means_counts$Clontech[order(-rank(Means_counts$Clontech))]))[1:20])
Illumina_top <- data.frame(rownames(data.frame(Means_counts$Illumina[order(-rank(Means_counts$Illumina))]))[1:20])
NEB_top <- data.frame(rownames(data.frame(Means_counts$NEB[order(-rank(Means_counts$NEB))]))[1:20])
NEXTflex_top <- data.frame(rownames(data.frame(Means_counts$NEXTflex[order(-rank(Means_counts$NEXTflex))]))[1:20])
Deduped_top <- data.frame(rownames(data.frame(Means_counts$Deduped[order(-rank(Means_counts$Deduped))]))[1:20])
Fivepercent_top <- data.frame(rownames(data.frame(Means_counts$Fivepercent[order(-rank(Means_counts$Fivepercent))]))[1:20])



Clontech_top <- data.frame(rownames(data.frame(Means_counts$Clontech[order(-rank(Means_counts$Clontech))]))[1:50])
Illumina_top <- data.frame(rownames(data.frame(Means_counts$Illumina[order(-rank(Means_counts$Illumina))]))[1:50])
NEB_top <- data.frame(rownames(data.frame(Means_counts$NEB[order(-rank(Means_counts$NEB))]))[1:50])
NEXTflex_top <- data.frame(rownames(data.frame(Means_counts$NEXTflex[order(-rank(Means_counts$NEXTflex))]))[1:50])
Deduped_top <- data.frame(rownames(data.frame(Means_counts$Deduped[order(-rank(Means_counts$Deduped))]))[1:50])
Fivepercent_top <- data.frame(rownames(data.frame(Means_counts$Fivepercent[order(-rank(Means_counts$Fivepercent))]))[1:50])

Clontech_top <- data.frame(rownames(data.frame(Means_counts$Clontech[order(-rank(Means_counts$Clontech))]))[1:5])
Illumina_top <- data.frame(rownames(data.frame(Means_counts$Illumina[order(-rank(Means_counts$Illumina))]))[1:5])
NEB_top <- data.frame(rownames(data.frame(Means_counts$NEB[order(-rank(Means_counts$NEB))]))[1:5])
NEXTflex_top <- data.frame(rownames(data.frame(Means_counts$NEXTflex[order(-rank(Means_counts$NEXTflex))]))[1:5])
Deduped_top <- data.frame(rownames(data.frame(Means_counts$Deduped[order(-rank(Means_counts$Deduped))]))[1:5])
Fivepercent_top <- data.frame(rownames(data.frame(Means_counts$Fivepercent[order(-rank(Means_counts$Fivepercent))]))[1:5])

Top<-data.frame(Clontech_top, Illumina_top, NEB_top, NEXTflex_top, Deduped_top, Fivepercent_top)
names(Top)<- names(Means_counts)
data.frame(lapply(Top, sort))
library(VennDiagram)
gg_color_hue <- function(n) {
  hues = seq(15, 375, length = n + 1)
  hcl(h = hues, l = 65, c = 100)[1:n]
}

n = 6
cols = gg_color_hue(n)
cols <-cols[1:5]
#vp_1000 <- venn.diagram(Top[c(1:4, 6)], fill = c(cols), alpha = 0.5, filename = NULL, margin = 0.2, cat.dist = c(.3,.3,.3, .3, .3))# for checking fivepercent
#vp_1000 <- venn.diagram(Top[2:6], fill = c(cols), alpha = 0.5, filename = NULL, margin = 0.2, cat.dist = c(.3,.3,.3, .3, .3))#for checking fivepercent
vp_1000 <- venn.diagram(Top[1:5], fill = c(cols), alpha = 0.5, filename = NULL, margin = 0.2, cat.dist = c(.3,.3,.3, .3, .3))

# maybe it is the normalization???

split_kit_raw <- list()
for(i in unique(Pheno$startingAmt)) {
  for(kit in unique(Pheno$Kit)){
  split_kit_raw[[i]][[kit]] <- data.frame(miR_counts[which(Pheno$startingAmt == as.character(i) & Pheno$Kit == as.character(kit))])}
}

Means_raw <- lapply(split_kit_raw$`1000`, rowMeans)
#What percentage of miRNAs account for 50% of the reads
lapply(Means_raw,get_num_less_than_100)
melted_raw<-melt(Means_raw)
melted_counts<-melt(Means_counts)
 # melted_raw$value<- log2(melted_raw$value)
 # melted_counts$value<- log2(melted_counts$value)

library(gridExtra)
library(grid)
library(lattice)
norm <-ggplot(melted_counts[which(melted_counts$value>10),], aes(x = L1, y = value, color = L1)) + geom_boxplot()+theme(legend.position = "none")
raw <-ggplot(melted_raw[which(melted_counts$value>10),], aes(x = L1, y = value, color = L1)) + geom_boxplot() +theme(legend.position = "none")
grid.arrange(norm, raw, ncol = 2)


rownames(Means_counts)<-NULL
norm_ordered <-lapply(Means_counts, sort, decreasing = TRUE)
raw_ordered <-lapply(Means_raw, sort, decreasing = TRUE)

length(which(raw_ordered$Clontech>10))
length(which(raw_ordered$Illumina>10))
length(which(raw_ordered$NEB>10))
length(which(raw_ordered$NEXTflex>10))
length(which(raw_ordered$Deduped>10))

length(which(raw_ordered$Clontech>1000))
length(which(raw_ordered$Illumina>1000))
length(which(raw_ordered$NEB>1000))
length(which(raw_ordered$NEXTflex>1000))
length(which(raw_ordered$Deduped>1000))

length(which(raw_ordered$Clontech>2000))
length(which(raw_ordered$Illumina>2000))
length(which(raw_ordered$NEB>2000))
length(which(raw_ordered$NEXTflex>2000))
length(which(raw_ordered$Deduped>2000))

 length(which(raw_ordered$Clontech>100000))
 length(which(raw_ordered$Illumina>100000))
 length(which(raw_ordered$NEB>10000))
 length(which(raw_ordered$NEXTflex>10000))
 length(which(raw_ordered$Deduped>10000))
 
 
 length(which(norm_ordered$Clontech>100000))
 length(which(norm_ordered$Illumina>100000))
 length(which(norm_ordered$NEB>10000))
 length(which(norm_ordered$NEXTflex>10000))
 length(which(norm_ordered$Deduped>10000))

 get_percentage <-function(x){x/(sum(x)*100)}
norm_percent_reads <-lapply(norm_ordered, get_percentage)
raw_percent_reads <-lapply(raw_ordered, get_percentage)

head(Means_counts$Clontech)
sum(norm_ordered$Clontech)
```


pdf(file =here("Figures/Raw_plots/Venn_of_top_expressed.pdf"),width=6,height=6,onefile=FALSE)
grid.draw(vp_1000);
dev.off()









How consistent are the results...
```{r}

library(genefilter)
library(VennDiagram)
library(reshape2)
library(ggplot2)

thresh_number <-data.frame(thresh_number)
colnames(thresh_number) <-c("100", "250", "500", "1000", "1500", "2000")
thresh_number$kit <- rownames(thresh_number)
to_repeat <-function(x) { rep(x,3)}
thresh_kits <-data.frame(t(thresh_number))
ggplot(thresh_kits, aes(x = ))
Clontech <-data.frame(t=unlist(lapply(thresh_kits$Clontech[1:6], to_repeat)))
Illumina<-data.frame(t=unlist(lapply(thresh_kits$Illumina[4:6], to_repeat)))
NEB<-data.frame(t=unlist(lapply(thresh_kits$NEB[1:4], to_repeat)))
NEXTflex<-data.frame(t=unlist(lapply(thresh_kits$NEXTflex[1:6], to_repeat)))
Deduped<-data.frame(t=unlist(lapply(thresh_kits$Deduped[1:6], to_repeat)))
Fivepercent<- data.frame(t=unlist(lapply(thresh_kits$Fivepercent[1:6], to_repeat)))

thresh_across_amts<-rbind(Clontech, Illumina, NEB, NEXTflex, Deduped, Fivepercent)


det_Data$det_across_thresh<-thresh_across_amts$t
det_Data$not_consistent <- ((det_Data$det_indv_thresh - as.numeric(as.character(det_Data$det_across_thresh)))/det_Data$det_indv_thresh)*100 #calculating percent inconsistent detection compared to across thriplicate thresh
detected <-data.frame(det_Data$kit, det_Data$startingAmt, det_Data$not_consistent)

detected$det_Data.kit<-factor(detected$det_Data.kit, levels = c("Clontech", "Illumina", "NEB", "NEXTflex", "Deduped","Fivepercent"))
detected$det_Data.startingAmt <-gsub("starting_amt_", "",detected$det_Data.startingAmt)
detected$det_Data.startingAmt<-factor(detected$det_Data.startingAmt, levels = c("100", "250", "500", "1000", "1500","2000"))

pdf(file =here("Figures/Raw_plots/miRNA_inconsistency.pdf"),width=10,height=6)
ggplot(detected, aes(x =det_Data.startingAmt, y=det_Data.not_consistent, fill = det_Data.kit)) + geom_boxplot()+ facet_grid(.~det_Data.kit) + theme(legend.position = "none", axis.text.x = element_text(size =17, angle = 60, hjust = 1), axis.text.y = element_text(size =15, hjust = 1), axis.title=element_text(size = 20), plot.title = element_text(size = 30), strip.text.x = element_text(size = 20)) + labs( x= "Starting Amount", y = " Percentage of Inconsistently \n Detected miRNA Sequences", title = "Inconsistentcy of miRNA Detection Across Kits") +geom_smooth(method = "loess", se=TRUE, color="black", aes(group=1)) +ylim(c(0,30))
dev.off()

library(sjstats)
summary(lm(det_Data$not_consistent~ det_Data$kit)) #sig difference in det inconsisentency across methods
anova_stats(anova(lm(det_Data$not_consistent~ det_Data$kit)))
summary(lm(det_Data$not_consistent~ det_Data$startingAmt)) #sig difference in det inconsisentency across methods
cor(det_Data$not_consistent, det_Data$startingAmt)
anova_stats(anova(lm(det_Data$not_consistent~ det_Data$startingAmt)))
Clontech <- det_Data[which(det_Data$kit == "Clontech"),]
summary(lm(Clontech$not_consistent~Clontech$startingAmt))#F-statistic: 4.128 on 1 and 16 DF,  p-value: 0.05913
cor(Clontech$not_consistent,Clontech$startingAmt)
NEB<- det_Data[which(det_Data$kit == "NEB"),]
summary(lm(NEB$not_consistent~NEB$startingAmt))
cor(NEB$not_consistent,NEB$startingAmt)
Deduped<- det_Data[which(det_Data$kit == "Deduped"),]
summary(lm(Deduped$not_consistent~Deduped$startingAmt))#F-statistic: 32.44 on 1 and 16 DF,  p-value: 3.313e-05
cor(Deduped$not_consistent,Deduped$startingAmt)
Fivepercent<- det_Data[which(det_Data$kit == "Fivepercent"),]
summary(lm(Fivepercent$not_consistent~Fivepercent$startingAmt))#F-statistic: 11.86 on 1 and 16 DF,  p-value: 0.003334
cor(Fivepercent$not_consistent,Fivepercent$startingAmt)
Illumina <- det_Data[which(det_Data$kit == "Illumina"),]
summary(lm(Illumina$not_consistent~Illumina $startingAmt))
cor(Illumina$not_consistent,Illumina $startingAmt)
NEXTflex <- det_Data[which(det_Data$kit == "NEXTflex"),]
summary(lm(NEXTflex$not_consistent~NEXTflex $startingAmt))
cor(NEXTflex$not_consistent,NEXTflex $startingAmt)
inconsistency <-list(Clontech$not_consistent, Illumina$not_consistent, NEB$not_consistent, NEXTflex$not_consistent, Deduped$not_consistent, Fivepercent$not_consistent)

inconsistency<-lapply(inconsistency, data.frame)
names(inconsistency)<-c("Clontech", "Illumina", "NEB", "NEXTflex", "Deduped", "Fivepercent")

get_test_names(inconsistency)

get_test_results<- function(data,test_names, pairedvalue) {
  tresults<<-list()
  tested_names1<<-list()
  tested_names2<<-list()
  length_kits <<-list()
  for(i in names(test_names)){
    Kit1 <-data[which(names(data) %in% test_names[i][1,])]
    Kit2 <-data[which(names(data) %in% test_names[i][2,])]
    tested_names1[[i]]<<-names(data)[names(data) %in% test_names[i][1,]]
    tested_names2[[i]]<<-names(data)[names(data) %in% test_names[i][2,]]
    tresults[[i]]<<-t.test(x=Kit1[[1]], y=Kit2[[1]], paired = pairedvalue)
    tested_kits <<-paste0(tested_names1, "&", tested_names2)
    length_kits[[i]]<<-c(length(Kit1[[1]][[1]]), length(Kit2[[1]][[1]]))
  }
}

get_test_results(data = inconsistency, test_names = test_names, pairedvalue = FALSE)
ttestStats_across<-data.frame(lapply(tresults, get_ttestStats))
colnames(ttestStats_across)<-tested_kits
t(ttestStats_across)

#grid.draw(vp_alpha);
#venn.plot <- venn.diagram(
# x = miRNA_det,
#  filename = NULL
#)
#grid.draw(venn.plot)



 get_t.es.g(ts = tresults)
 t(data.frame(t.es.g))


Means<-unlist(lapply(inconsistency, colMeans))
test_names<-names(Means)
get_perc_diff <-function(data) {
  percresults<<-list()
  tested_names1<<-list()
  tested_names2<<-list()
  tested_kits<<-list()
  for(i in names(test_names)){
    percresults[[i]]<<-((data[ which(names(data)==test_names[i][1,])]-data[ which(names(data)==test_names[i][2,])]))/ data[ which(names(data)==test_names[i][2,])]*100
    tested_names1[[i]]<<-test_names[i][1,]
    tested_names2[[i]]<<-test_names[i][2,]
    tested_kits[[i]] <<-paste0(tested_names1[[i]], "&", tested_names2[[i]])
    }
}
get_test_names(Means)
get_perc_diff(data = Means)
perc_stats<-data.frame(percresults)
colnames(perc_stats)<-tested_kits
t(perc_stats)


```
#general detection plot with across and indv thresh
```{r}
head(det_Data)

across <- data.frame(det_Data$kit, det_Data$startingAmt, det_Data$det_across_thresh)
raw_det<- data.frame(det_Data$kit, det_Data$startingAmt, det_Data$det_indv_thresh)
across$det_Data.det_across_thresh<-as.numeric(as.character(across$det_Data.det_across_thresh))
anova(lm(across$det_Data.det_across_thresh~ across$det_Data.kit))#sig
anova(lm(across$det_Data.det_across_thresh~ across$det_Data.startingAmt))#sig

across$det_Data.kit<-factor(detected$det_Data.kit, levels = c("Clontech", "Illumina", "NEB", "NEXTflex", "Deduped","Fivepercent"))
across$det_Data.startingAmt<-factor(detected$det_Data.startingAmt, levels = c("100", "250", "500", "1000", "1500","2000"))


pdf(file =here("Figures/Raw_plots/miRNA_Det_indv_thresh_across_amounts_together.pdf"),width=10,height=6)
ggplot(across, aes(y =det_Data.det_across_thresh, x =det_Data.kit, fill = det_Data.kit )) +geom_boxplot()+ geom_jitter(color = "black",aes( alpha = 0.5), width = 0.2)+ theme(legend.position = "none", axis.text.x = element_text(size =17, angle = 60, hjust = 1, color = "black"), axis.text.y = element_text(size =20, hjust = 1, color = "black"), axis.title.y =element_text(size = 20), axis.title.x = element_text(size = 0), plot.title = element_text(size = 30)) + labs(y = " Detected unique miRNAs", title = " miRNA Detection Across Kits") 
dev.off()

across_agg<-aggregate(across, by = list(Pheno$TriplicateGroup), FUN = mean)

raw_det$det_Data.kit<-factor(detected$det_Data.kit, levels = c("Clontech", "Illumina", "NEB", "NEXTflex", "Deduped","Fivepercent"))
raw_det$det_Data.startingAmt<-factor(detected$det_Data.startingAmt, levels = c("100", "250", "500", "1000", "1500","2000"))

pdf(file =here("Figures/Raw_plots/miRNA_Det_indv_thresh_across_amounts.pdf"),width=10,height=6)
ggplot(raw_det, aes(x =det_Data.startingAmt, y=det_Data.det_indv_thresh, fill = det_Data.kit)) + geom_boxplot() + geom_jitter(aes(color = det_Data.kit))+ facet_grid(.~det_Data.kit) + theme(legend.position = "none", axis.text.x = element_text(size =17, angle = 60, hjust = 1), axis.text.y = element_text(size =15, hjust = 1), axis.title=element_text(size = 20), plot.title = element_text(size = 30), strip.text.x = element_text(size = 20)) + labs( x= "Starting Amount", y = " Detected miRNA Sequences", title = " miRNA Detection Across Kits") +geom_smooth(method = "loess", se=TRUE, color="black", aes(group=1))
dev.off()

pdf(file =here("Supplement/Figures/line_graph_miRNA_Det_across_thresh_all_amounts.pdf"),width=10,height=6)
ggplot(across, aes(x =det_Data.startingAmt, y=det_Data.det_across_thresh, fill = det_Data.kit)) + geom_boxplot() + geom_jitter(aes(color = det_Data.kit))+ facet_grid(.~det_Data.kit) + theme(legend.position = "none", axis.text.x = element_text(size =17, angle = 60, hjust = 1), axis.text.y = element_text(size =15, hjust = 1), axis.title=element_text(size = 20), plot.title = element_text(size = 30), strip.text.x = element_text(size = 20)) + labs( x= "Starting Amount", y = " Detected miRNA Sequences", title = " miRNA Detection Across Kits") +geom_smooth(method = "loess", se=TRUE, color="black", aes(group=1))
dev.off()


# ggplot(raw_det, aes(x =det_Data.startingAmt, y=det_Data.det_indv_thresh, fill = det_Data.kit)) + geom_boxplot() + geom_jitter(aes(color = det_Data.kit))+ facet_grid(.~det_Data.kit, scales="free") + theme(legend.position = "none", axis.text.x = element_text(size =17, angle = 60, hjust = 1), axis.text.y = element_text(size =15, hjust = 1), axis.title=element_text(size = 20), plot.title = element_text(size = 30), strip.text.x = element_text(size = 20)) + labs( x= "Starting Amount", y = " Detected miRNA Sequences", title = " miRNA Detection Across Kits") +geom_smooth(method = "loess", se=TRUE, color="black", aes(group=1))+ geom_line(data = across, linetype =2, size =1.0001, aes(x=det_Data.startingAmt, y=det_Data.det_across_thresh, group=det_Data.kit, colour=det_Data.kit)) + geom_point(data = across, aes(x=det_Data.startingAmt, y=det_Data.det_across_thresh, group=det_Data.kit, color = det_Data.kit), shape=24)

pdf(file =here("Figures/Raw_plots/miRNA_Det.pdf"),width=10,height=6)
ggplot(raw_det, aes(x =det_Data.startingAmt, y=det_Data.det_indv_thresh, fill = det_Data.kit)) + geom_boxplot() + facet_grid(.~det_Data.kit) + theme(legend.position = "none", axis.text.x = element_text(size =17, angle = 60, hjust = 1), axis.text.y = element_text(size =15, hjust = 1), axis.title=element_text(size = 20), plot.title = element_text(size = 30), strip.text.x = element_text(size = 20)) + labs( x= "Starting Amount", y = " Detected miRNA Sequences", title = " miRNA Detection Across Kits") +geom_smooth(method = "loess", se=TRUE, color="black", aes(group=1))+ geom_line(data = across, linetype =2, size =1, aes(x=det_Data.startingAmt, y=det_Data.det_across_thresh, group=det_Data.kit, colour=det_Data.kit)) + geom_point(data = across, aes(x=det_Data.startingAmt, y=det_Data.det_across_thresh, group=det_Data.kit, color = det_Data.kit), shape=24)+ ylim(100,1000)
dev.off()


#Just 1000ng

raw_det_1000 <- raw_det[which(raw_det$det_Data.startingAmt == "1000"),]
across_det_1000 <- across[which(across$det_Data.startingAmt == "1000"),]
across_1000<-aggregate(across_det_1000, by = list(across_det_1000$det_Data.kit), FUN = mean)
across_1000<-data.frame(Kit =across_1000$Group.1, Detection =across_1000$det_Data.det_across_thresh)
across_1000$sd<-aggregate(raw_det_1000$det_Data.det_indv_thresh, by = list(raw_det_1000$det_Data.kit), FUN = sd)

# ggplot(raw_det_1000, aes(x =det_Data.kit, y=det_Data.det_indv_thresh, fill = det_Data.kit)) + geom_boxplot() + geom_jitter()  + theme(legend.position = "none", axis.text.x = element_text(size =17, angle = 60, hjust = 1), axis.text.y = element_text(size =15, hjust = 1), axis.title=element_text(size = 20), plot.title = element_text(size = 30), strip.text.x = element_text(size = 20)) + labs( x= "Starting Amount", y = " Detected miRNA Sequences", title = " miRNA Detection Across Kits")  + geom_boxplot(data = across, aes(x=det_Data.kit, y=det_Data.det_across_thresh, group=det_Data.kit, alpha = 0.7), color = "black") + geom_point(data = across, aes(x=det_Data.kit, y=det_Data.det_across_thresh, group=det_Data.kit), color = "black", shape=24)
# 
# 
# #1000ng indv miRNA Detection
# ggplot(raw_det_1000, aes(x =det_Data.kit, y=det_Data.det_indv_thresh, fill = det_Data.kit)) + geom_boxplot() + geom_jitter()  + theme(legend.position = "none", axis.text.x = element_text(size =17, angle = 60, hjust = 1), axis.text.y = element_text(size =15, hjust = 1), axis.title=element_text(size = 20), plot.title = element_text(size = 30), strip.text.x = element_text(size = 20)) + labs( x= "Starting Amount", y = " Detected miRNA Sequences", title = " miRNA Detection Across Kits") 


#1000ng across miRNA Detection
pdf(file =here("Figures/Raw_plots/miRNA_1000ng_detection.pdf"),width=4,height=6)
ggplot(across_1000, aes(x =Kit, y=Detection, fill = Kit)) + geom_bar(stat = "identity", aes(y =Detection, fill = Kit)) + theme(legend.position = "none", axis.text.x = element_text(size =17, angle = 60, hjust = 1, color = "black"), axis.text.y = element_text(size =18, hjust = 1, color = "black"), axis.title.y=element_text(size = 20)) + labs(y = " Detected Unique miRNA Sequences") +coord_cartesian(ylim=c(300,600))+ geom_text(aes(label = (Detection), size = 6, hjust = 0.5, vjust = 1.5) ) 
dev.off()


names(raw_det_1000) <- c("Kit", "amt", "value")
across_1000$mean <- aggregate(raw_det_1000$value, by = list(raw_det_1000$Kit), FUN = mean)
across_1000$up <-across_1000$mean+across_1000$sd
across_1000$down <-across_1000$mean-across_1000$sd
#adding jitter and error bar
pdf(file =here("Figures/Raw_plots/miRNA_1000ng_detection_bar_with_error.pdf"),width=4,height=6)
ggplot(across_1000, aes(x =Kit, y=Detection, fill = Kit)) + geom_bar(stat = "identity", aes(y =Detection, fill = Kit), position=position_dodge(width = 0.9)) + theme(legend.position = "none", axis.text.x = element_text(size =17, angle = 60, hjust = 1, color = "black"), axis.text.y = element_text(size =18, hjust = 1, color = "black"), axis.title.y=element_text(size = 20)) + labs(y = " Detected Unique miRNA Sequences") +coord_cartesian(ylim=c(300,725))+ geom_text(aes(label = (Detection), size = 6, hjust = 0.5, vjust = 1.5 )) +geom_jitter(data = raw_det_1000, aes(x = Kit, y =value),color = "black", width = 0.02) +geom_errorbar(aes(ymin =across_1000$up$x, ymax=across_1000$down$x, x = across_1000$Kit, y = across_1000$Detection),color = "black", position=position_dodge(width = 0.9))
dev.off()



det_Data_1000 <- detected[which(detected$det_Data.startingAmt == "1000"),]

pdf(file =here("Figures/Raw_plots/miRNA_1000ng_inconsistency.pdf"),width=4,height=6)
ggplot(det_Data_1000, aes(x =det_Data.kit, y=det_Data.not_consistent, fill = det_Data.kit))  + geom_boxplot() + geom_jitter(width = 0.2) +theme(legend.position = "none", axis.text.x = element_text(size =17, angle = 60, hjust = 1), axis.text.y = element_text(size =15, hjust = 1), axis.title=element_text(size = 20), plot.title = element_text(size = 30), strip.text.x = element_text(size = 20)) + labs( x= "Starting Amount", y = " Percentage of Inconsistently \n Detected miRNA Sequences", title = "Inconsistentcy of miRNA Detection Across Kits")+coord_cartesian(ylim=c(0,30)) 
dev.off()
summary(lm(det_Data_1000$det_Data.not_consistent~ det_Data_1000$det_Data.kit)) #sig difference in det inconsisentency across methods
anova_stats(anova(lm(det_Data_1000$det_Data.not_consistent~ det_Data_1000$det_Data.kit)))
library(tidyr)
det_Data_1000$sample <- rep(c(1,2,3),6)
det_Data <-spread(det_Data_1000, sample, det_Data.not_consistent)
det_Data <-data.frame(t(det_Data))
det_Data<-det_Data[-1,]
det_Data<-det_Data[-1,]
colnames(det_Data)<-c("Clontech", "Illumina", "NEB", "NEXTflex", "Deduped", "Fivepercent")

```

Stats on Detection
```{r}
get_test_results<- function(data,test_names, pairedvalue) {
  tresults<<-list()
  tested_names1<<-list()
  tested_names2<<-list()
  length_kits <<-list()
  for(i in names(test_names)){
    Kit1 <-data[which(names(data) %in% test_names[i][1,])]
    Kit2 <-data[which(names(data) %in% test_names[i][2,])]
    tested_names1[[i]]<<-names(data)[names(data) %in% test_names[i][1,]]
    tested_names2[[i]]<<-names(data)[names(data) %in% test_names[i][2,]]
    tresults[[i]]<<-t.test(x=Kit1[[1]], y=Kit2[[1]], paired = pairedvalue)
    tested_kits <<-paste0(tested_names1, "&", tested_names2)
    length_kits[[i]]<<-c(length(Kit1[[1]][[1]]), length(Kit2[[1]][[1]]))
  }
}

get_ttestStats<- function(x, tested_kits) {
  c(t =format(x$statistic, digits = 2),
    df = format(x$parameter, digits = 0),
    p.value = format(x$p.value, scientific = TRUE, digits = 2),
    bonferroni.threshold = format(.05/length(test_names), digits = 2),
    sig = ifelse(x$p.value<(.05/length(test_names)), "yes", "no"),
    t.es.g =tes(x$statistic, n.1 = 3, n.2 = 3)$g)
}


get_perc_diff <-function(data) {
  percresults<<-list()
  tested_names1<<-list()
  tested_names2<<-list()
  tested_kits<<-list()
  for(i in names(test_names)){
    percresults[[i]]<<-((colMeans(data)[ which(names(colMeans(data))==test_names[i][1,])]-colMeans(data)[ which(names(colMeans(data))==test_names[i][2,])])/ colMeans(data)[ which(names(colMeans(data))==test_names[i][2,])])*100
    tested_names1[[i]]<<-test_names[i][1,]
    tested_names2[[i]]<<-test_names[i][2,]
    tested_kits[[i]] <<-paste0(tested_names1[[i]], "&", tested_names2[[i]])
    }
}

raw_det_1000 <- raw_det[which(raw_det$det_Data.startingAmt == "1000"),]
anova(lm(raw_det_1000$det_Data.det_indv_thresh ~ raw_det_1000$det_Data.kit))# significant difference between kits for raw detection
raw_det_1000$number <-rep(c(1:3),6)
raw_1000<-dcast(raw_det_1000, number~det_Data.kit , value.var = "det_Data.det_indv_thresh") # to wide format
raw_1000$number <-NULL
get_test_names(raw_1000)
get_test_results(raw_1000, test_names = test_names, pairedvalue = TRUE)
ttestStats_across<-data.frame(lapply(tresults, get_ttestStats, tested_kits = tested_kits))
colnames(ttestStats_across)<-tested_kits
t(ttestStats_across) #lower t indicates lower error across triplicates



 get_perc_diff(data.frame(raw_1000))
perc_stats<-data.frame(percresults)
colnames(perc_stats)<-tested_kits
t(perc_stats)
 
```

# get lists of miRNAs for across thresholds for given starting amounts
```{r}
str(split_amt_thresh)
miRNAs_100ng<-lapply(split_amt_thresh$`100`, rownames)
miRNAs_250ng<-lapply(split_amt_thresh$`250`, rownames)
miRNAs_500ng<-lapply(split_amt_thresh$`500`, rownames)
names(miRNAs_500ng)<-c("Clontech\n(567)","Illumina\n(null)", "NEB\n(504)", "NEXTflex\n(486)","Deduped\n(514)","Fivepercent\n(425)")
miRNAs_500ng<-miRNAs_500ng[-2]
miRNAs_1000ng<-lapply(split_amt_thresh$`1000`, rownames)
names(miRNAs_1000ng)<-c("Clontech\n(504)","Illumina\n(473)", "NEB\n(511)", "NEXTflex\n(487)","Deduped\n(556)","Fivepercent\n(418)")
miRNAs_1500ng<-lapply(split_amt_thresh$`1500`, rownames)
miRNAs_2000ng<-lapply(split_amt_thresh$`2000`, rownames)

```

VennDiagram
```{r}
library(VennDiagram)

gg_color_hue <- function(n) {
  hues = seq(15, 375, length = n + 1)
  hcl(h = hues, l = 65, c = 100)[1:n]
}

n = 6
cols = gg_color_hue(n)
cols <-cols[1:5]
vp_1000 <- venn.diagram(miRNAs_1000ng[1:5], fill = c(cols), alpha = 0.5, filename = NULL, margin = 0.2, cat.dist = c(.3,.3,.3, .3, .3))



gg_color_hue <- function(n) {
  hues = seq(15, 375, length = n + 1)
  hcl(h = hues, l = 65, c = 100)[1:n]
}

n = 6
cols = gg_color_hue(n)
cols <-cols[c(1,3,4,5,6)]
vp_alpha <- venn.diagram(miRNAs_500ng, fill = c(cols), alpha = 0.5, filename = NULL, margin = 0.2, cat.dist = c(.3,.3,.3, .3, .3))

grid.draw(vp_alpha);

#dev.new(width = 4, height = 4)
#plot(1:n, pch = 16, cex = 2, col = cols)
```



pdf(file =here("Figures/Raw_plots/Venn.pdf"),width=6,height=6,onefile=FALSE)
grid.draw(vp_1000);
dev.off()


```{r}
# library(genefilter)
# library(VennDiagram)
# library(reshape2)
# library(ggplot2)
# #library(venneuler)
# #poverafun <- genefilter::pOverA(p = .5, A = 529)# at least 529 reads for 50% of samples
# poverafun <- genefilter::pOverA(p = 1, A = 10)#at least 100 normalized reads in all samples of the set... 
# #poverafun <- genefilter::pOverA(p = 1, A = 10)#at least 10 raw reads in all samples #292
# #poverafun <- genefilter::pOverA(p = 1, A = 100)#at least 100 raw reads in all samples #125
# 
# ffun <- filterfun(poverafun)
# genefilt_fun<- function(x){genefilter(x, ffun)}
# thresh[[x]]<-for(x in names(split_kit_miRNAData)){lapply(split_kit_miRNAData[[x]], genefilt_fun)}
# 
# 
# split_kit_thresh <-list()
# for(x in names(split_kit_miRNAData)){ split_kit_thresh[[x]]<-split_kit_miRNAData[[x]][thresh[[x]]]}
# split_kit_thresh$Clontech<-split_kit_miRNAData$Clontech[thresh$Clontech,]
# split_kit_thresh$NEB<-split_kit$NEB[thresh$NEB,]
# split_kit_thresh$NEXTflex<-split_kit$NEXTflex[thresh$NEXTflex,]
# split_kit_thresh$Illumina<-split_kit$Illumina[thresh$Illumina,]
# split_kit_thresh$Deduped<-split_kit$Deduped[thresh$Deduped,]
# split_kit_thresh$Fivepercent<-split_kit$Fivepercent[thresh$Fivepercent,]
# 
# Clontech<-rep(dim(split_kit_thresh$Clontech)[1],18)
# Illumina<-rep(dim(split_kit_thresh$Illumina)[1],9)
# NEB<-rep(dim(split_kit_thresh$NEB)[1],12)
# NEXTflex<-rep(dim(split_kit_thresh$NEXTflex)[1],18)
# Deduped<-rep(dim(split_kit_thresh$Deduped)[1],18)
# Fivepercent<-rep(dim(split_kit_thresh$Fivepercent)[1],18)
# thresh_across_amts<-rbind(data.frame(t =Clontech), data.frame(t =Illumina), data.frame(t=NEB), data.frame(t=NEXTflex),data.frame(t=Deduped), data.frame(t = Fivepercent))
# 
# det_Data$det_across_thresh<-thresh_across_amts$t
# det_Data$not_consistent <- ((det_Data$det_indv_thresh - det_Data$det_across_thresh)/det_Data$det_indv_thresh)*100
# detected <-data.frame(det_Data$kit, det_Data$startingAmt, det_Data$not_consistent)
# 
# detected$det_Data.kit<-factor(detected$det_Data.kit, levels = c("Clontech", "Illumina", "NEB", "NEXTflex", "Deduped","Fivepercent"))
# detected$det_Data.startingAmt<-factor(detected$det_Data.startingAmt, levels = c("100", "250", "500", "1000", "1500","2000"))
# 
# 
# split_kit_thresh <- split_kit_thresh[1:5]#remove 5 % control
# 
# #doesn't include overlaps and greater than 4 expression value
# Clontech<-as.vector(rownames(split_kit_thresh$Clontech))
# Illumina<-as.vector(rownames(split_kit_thresh$Illumina))
# NEB<-as.vector(rownames(split_kit_thresh$NEB))
# NEXTflex<-as.vector(rownames(split_kit_thresh$NEXTflex))
# Deduped<-as.vector(rownames(split_kit_thresh$Deduped))
# 
# 
# 
# detected$det_Data.startingAmt <-gsub("starting_amt_", "",detected$det_Data.startingAmt)
# ggplot(detected, aes(x =det_Data.kit, y=det_Data.not_consistent, fill = det_Data.kit)) + geom_boxplot()+ facet_grid(.~det_Data.startingAmt)
# 
# 
# 
# miRNA_det<-list("Clontech\n(N=427)" = Clontech, "Illumina\n(N=443)" = Illumina, "NEB\n(N=450)" = NEB, "NextFlex\n(N=380)" =NEXTflex, "Deduped\n(N=427)" = Deduped)
# 
# 
# summary(lm(det_Data$not_consistent~ det_Data$kit)) #sig difference in det inconsisentency across methods
# #vp_alpha <- venn.diagram(miRNA_det, fill = c("red", "white", "blue", "green"), alpha = 0.5, filename = NULL)
# summary(lm(det_Data$not_consistent~ det_Data$startingAmt)) #sig difference in det inconsisentency across methods
# Clontech <- det_Data[which(det_Data$kit == "Clontech"),]
# summary(lm(Clontech$not_consistent~Clontech$startingAmt))#F-statistic: 4.128 on 1 and 16 DF,  p-value: 0.05913
# NEB<- det_Data[which(det_Data$kit == "NEB"),]
# summary(lm(NEB$not_consistent~NEB$startingAmt))
# Deduped<- det_Data[which(det_Data$kit == "Deduped"),]
# summary(lm(Deduped$not_consistent~Deduped$startingAmt))#F-statistic: 32.44 on 1 and 16 DF,  p-value: 3.313e-05
# Fivepercent<- det_Data[which(det_Data$kit == "Fivepercent"),]
# summary(lm(Fivepercent$not_consistent~Fivepercent$startingAmt))#F-statistic: 11.86 on 1 and 16 DF,  p-value: 0.003334
# #grid.draw(vp_alpha);
# #venn.plot <- venn.diagram(
# # x = miRNA_det,
# #  filename = NULL
# #)
# #grid.draw(venn.plot)
```






Characterize the unique miRNAs for each kit

Use the fasta file in documents..
```{r}
library(here)
library(Biostrings)
seqs = readRNAStringSet(here("mature_hsa.fa"))
#hmmm ignored several sequences
newnames<-sapply(strsplit(names(seqs), " "), `[`, 1) #just to grab the first object
names(seqs)<-newnames
#not all of the sequence names are the same as in the full human set...so we lose a small percentage

Clontech_seqs <-seqs[which(names(seqs) %in% rownames(split_amt_thresh$`1000`$Clontech)),]
Illumina_seqs <-seqs[which(names(seqs) %in% rownames(split_amt_thresh$`1000`$Illumina)),]
NEB_seqs <-seqs[which(names(seqs) %in% rownames(split_amt_thresh$`1000`$NEB)),]
NEXTflex_seqs <-seqs[which(names(seqs) %in% rownames(split_amt_thresh$`1000`$NEXTflex)),]
Deduped_seqs <-seqs[which(names(seqs) %in% rownames(split_amt_thresh$`1000`$Deduped)),]
Fivepercent_seqs <-seqs[which(names(seqs) %in% rownames(split_amt_thresh$`1000`$Fivepercent)),]
miRNA_det <- list(Clontech = Clontech_seqs, Illumina =Illumina_seqs, NEB= NEB_seqs, Deduped =Deduped_seqs, Fivepercent =Fivepercent_seqs)


besides_Clontech <-c(names(Illumina_seqs), names(NEB_seqs), names(NEXTflex_seqs), names(Deduped_seqs))
UniqueClontech <-Clontech_seqs[which(!names(Clontech_seqs) %in% besides_Clontech)]

besides_Illumina <-c(names(Clontech_seqs), names(NEB_seqs), names(NEXTflex_seqs), names(Deduped_seqs))
UniqueIllumina <-Illumina_seqs[which(!names(Illumina_seqs) %in% besides_Illumina)]

besides_NEB <-c(names(Illumina_seqs), names(Clontech_seqs), names(NEXTflex_seqs), names(Deduped_seqs))
UniqueNEB <-NEB_seqs[which(!names(NEB_seqs) %in% besides_NEB)]

besides_NEXTflex <-c(names(Illumina_seqs), names(NEB_seqs), names(Clontech_seqs), names(Deduped_seqs))
UniqueNEXTflex<-NEXTflex_seqs[which(!names(NEXTflex_seqs) %in% besides_NEXTflex)]

besides_Deduped <-c(names(Illumina_seqs), names(NEB_seqs), names(NEXTflex_seqs), names(Clontech_seqs))
UniqueDeduped <-Deduped_seqs[which(!names(Deduped_seqs) %in% besides_Deduped)]

allKits<-unique(c(names(Clontech_seqs),names(Illumina_seqs), names(NEB_seqs), names(NEXTflex_seqs), names(Deduped_seqs)))
allUnique<-c(names(UniqueClontech), names(UniqueIllumina), names(UniqueNEB), names(UniqueNEXTflex), names(UniqueDeduped))
Intersection <- allKits[which(!allKits %in% allUnique)]
Intersection<-seqs[which(names(seqs) %in% Intersection)]

# miRNA_det <-lapply(unlist(miRNA_det), data.frame)
# miRNA_det <-lapply(miRNA_det, rownames)
# fullset_listed_miRNAs<-unique(melt(miRNA_det)$value)
# fullset_filtered_miRNAs <-fullset_det_miRNAs[which(fullset_det_miRNAs %in% fullset_listed_miRNAs ),]

```


```{r}
GC_Clontech<-letterFrequency(UniqueClontech, letters = c("CG"), as.prob = TRUE)
GC_Illumina<-letterFrequency(UniqueIllumina, letters = c("CG"), as.prob = TRUE)
GC_NEB<-letterFrequency(UniqueNEB, letters = c("CG"), as.prob = TRUE)
GC_NEXTflex<-letterFrequency(UniqueNEXTflex, letters = c("CG"), as.prob = TRUE)
GC_Deduped<-letterFrequency(UniqueDeduped, letters = c("CG"), as.prob = TRUE)
GC_Intersection<-letterFrequency(Intersection, letters = c("CG"), as.prob = TRUE)

GC_cont <- list(Clontech =GC_Clontech, Illumina =GC_Illumina, NEB =GC_NEB, NEXTflex = GC_NEXTflex, Deduped =GC_Deduped, Intersection=GC_Intersection)

cols = gg_color_hue(6)
cols[6]<-c("#FFFFFF")

boxplot(GC_cont, col = cols, main = 'GC content of unique sequences across kits')

GCmelted <-melt(GC_cont[1:5])
anova(lm(GCmelted$value~ GCmelted$L1))# sig difference between the kits
GCmelted <-melt(GC_cont[1:6])
GCmelted$L1<- factor(GCmelted$L1, levels = c("Clontech", "Illumina", "NEB", "NEXTflex", "Deduped", "Intersection"))
pdf(here("Supplement/Figures/GCcontentUnique.pdf"), height = 8, width = 10)
ggplot(GCmelted, aes(x = L1, y = value, fill = L1)) + geom_boxplot(varwidth = TRUE) + geom_jitter( width=0.08) + ylab("GC content of uniquely detected sequences")+ theme(axis.title.x = element_text(size =0),
            axis.text.x = element_text(size = 20, angle = 60, color = "black", hjust = 1),
            axis.text.y = element_text(size = 20, color = "black"),
            axis.title.y = element_text(size =20),
            legend.position= "none")  +scale_fill_manual(values = cols)
dev.off()
# Analysis of Variance Table
# 
# Response: GCmelted$value
#              Df  Sum Sq Mean Sq F value    Pr(>F)     omega = 0.193
# GCmelted$L1   4 0.45695 0.11424  8.1195 8.498e-06 ***
# Residuals   114 1.60393 0.01407                     

#bonferroni thresh = 0.0125
t.test(GC_Intersection, GC_NEB)
t.test(GC_Intersection, GC_NEXTflex)
t.test(GC_Intersection, GC_Illumina)
t.test(GC_Intersection, GC_Clontech)## significant!!!!!!!!!!!!
t.test(GC_Intersection, GC_Deduped) 

# 	Welch Two Sample t-test
# 
# data:  GC_Intersection and GC_Clontech
# t = -3.5671, df = 45.868, p-value = 0.0008583
# alternative hypothesis: true difference in means is not equal to 0
# 95 percent confidence interval:
#  -0.1267367 -0.0352952
# sample estimates:
# mean of x mean of y 
# 0.4992064 0.5802224 

widths <- list(Clontech =width(UniqueClontech), Illumina =width(UniqueIllumina), NEB =width(UniqueNEB), NEXTflex = width(UniqueNEXTflex), Deduped =width(UniqueDeduped))
widths<-melt(widths)
anova(lm(widths$value~widths$L1)) #no sig difference

t.test(width(Intersection), width(UniqueClontech))
t.test(width(Intersection), width(UniqueNEB)) 
t.test(width(Intersection), width(UniqueIllumina)) 
t.test(width(Intersection), width(UniqueNEXTflex))
t.test(width(Intersection), width(UniqueDeduped)) 

```











