---
title: "SD"
author: "Carrie Wright"
date: "6/20/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```


```{r, eval=TRUE, echo=FALSE}
library(edgeR)
library(here)

load(here("Complete_data/IsomiR_data/Pheno.rda"))
Pheno1000 <- Pheno[which(Pheno$startingAmt =="1000"),]
miR_counts<-read.table(here("Complete_data/miR.Counts.csv"), header = TRUE, sep = ",")

rownames(miR_counts)<- miR_counts$miRNA#make miRNA rownames
miR_counts<-miR_counts[,2:length(colnames(miR_counts))]#remove miRNA col
miRNAtotal<-t(miR_counts[1,])#extract the total miRNA counts... in case we want them
miR_counts<-miR_counts[-1,]#remove total miRNA counts row
miR_counts<-miR_counts[,-2]#remove extra Clontech sample

colnames(miR_counts)<-gsub("directional_dedupped|directional_deduped", "Deduped", colnames(miR_counts))
colnames(miR_counts)<-gsub("Five_double", "Fivepercent", colnames(miR_counts))

Pheno1000$Kit<-gsub("Five_double", "Fivepercent", Pheno1000$Kit)
Pheno1000$File<-gsub("Five_double", "Fivepercent", Pheno1000$File)

Pheno1000$File<-gsub("directional_deduped", "Deduped", Pheno1000$File)
Pheno1000$Kit<-gsub("NEXTflex_deduped", "Deduped", Pheno1000$Kit)
Pheno1000$TriplicateGroup<-gsub("directional_deduped", "Deduped", Pheno1000$TriplicateGroup)
miR_1000_raw <- data.frame(miR_counts[,which(Pheno$startingAmt == "1000")])
 
load(here("hsa_miRNA_info.rda"))

```


###DESeq2
```{r, eval=TRUE,warning=FALSE, message=FALSE, echo =FALSE}
library(DESeq2)
dds<-DESeqDataSetFromMatrix(countData = miR_1000_raw, colData = Pheno1000, design = ~ File)
dds <- estimateSizeFactors(dds)
norm_miR_1000<-data.frame(counts(dds, normalized = TRUE))
dim(norm_miR_1000)
```

```{r}
###split the data by kit
split_kit <- list() 
for(i in Pheno1000$Kit) { 
  split_kit[[i]] <- data.frame(norm_miR_1000[which(Pheno1000$Kit==i)])
} 
str(split_kit)
```





```{r}
###genefilter
library(genefilter)

poverafun <- genefilter::pOverA(p = 1, A = 10)#at least 10 normalized reads in all samples of the set... 
ffun <- filterfun(poverafun)
genefilt_fun<- function(x){genefilter(x, ffun)}
thresh<-lapply(split_kit, genefilt_fun)

split_kit_thresh <-list()
split_kit_thresh$Clontech<-split_kit$Clontech[thresh$Clontech,]
split_kit_thresh$Illumina<-split_kit$Illumina[thresh$Illumina,]
split_kit_thresh$NEB<-split_kit$NEB[thresh$NEB,]
split_kit_thresh$NEXTflex<-split_kit$NEXTflex[thresh$NEXTflex,]
split_kit_thresh$Deduped<-split_kit$Deduped[thresh$Deduped,]
split_kit_thresh$Fivepercent<-split_kit$Fivepercent[thresh$Fivepercent,]

Names_thresh<-intersect(intersect(intersect(intersect(intersect(rownames(split_kit_thresh[[1]]), rownames(split_kit_thresh[[2]])), rownames(split_kit_thresh[[3]])), rownames(split_kit_thresh[[4]])), rownames(split_kit_thresh[[5]])), rownames(split_kit_thresh[[6]]))

finding_rows<-function(x){x[rownames(x) %in% Names_thresh, , drop= FALSE]}
```


###Standard Deviation
is it ok to take the SD fo 2 numbers?
https://math.stackexchange.com/questions/1584608/is-it-valid-to-calculate-standard-deviation-for-n-2

Basically I look at the SD of each miRNA across the two batches.

```{r}
library(dplyr)
library(reshape2)
library(ggplot2)

Union<-lapply(split_kit_thresh,  finding_rows)
Union<-lapply(Union, log2)
###need to compare batch 2 to average of batch 1

Union$Clontech[2:4]<-rowMeans(Union$Clontech[2:4])########## get mean of batch1
Union$Clontech[3:4] <-NULL###########remove reapeats
Union$Illumina[2:4]<-rowMeans(Union$Illumina[2:4])
Union$Illumina[3:4] <-NULL
Union$NEB[2:4]<-rowMeans(Union$NEB[2:4])
Union$NEB[3:4] <-NULL
Union$NEXTflex[2:4]<-rowMeans(Union$NEXTflex[2:4])
Union$NEXTflex[3:4] <-NULL
Union$Deduped[2:4]<-rowMeans(Union$Deduped[2:4])
Union$Deduped[3:4] <-NULL
Union$Fivepercent[2:4]<-rowMeans(Union$Fivepercent[2:4])
Union$Fivepercent[3:4] <-NULL

str(Union) # here we see the raw data for batch2 (called 11 for all but clontech) and the mean of batch1 for each kit

sdtest <- lapply(Union,rowSds)#genefilter
vartest <-lapply(Union,rowVars)


test_names <- data.frame(combn(names(Union), m= 2))

get_test_results<- function(data,test_names, pairedvalue) {
  tresults<<-list()
  tested_names1<<-list()
  tested_names2<<-list()
  for(i in names(test_names)){
    Kit1 <-data[which(names(data) %in% test_names[i][1,])]
    Kit2 <-data[which(names(data) %in% test_names[i][2,])]
    Kit1<-data.frame(select(data, colnames(data)[colnames(data) %in% test_names[i][1,]]))
    Kit2<-data.frame(select(data, colnames(data)[colnames(data) %in% test_names[i][2,]]))
    tested_names1[[i]]<<-names(data)[names(data) %in% test_names[i][1,]]
    tested_names2[[i]]<<-names(data)[names(data) %in% test_names[i][2,]]
    colnames(Kit1)<-c("error")
    colnames(Kit2)<-c("error")
    tresults[[i]]<<-t.test(x=Kit1[[1]], y=Kit2[[1]], paired = pairedvalue)
    tested_kits <<-paste0(tested_names1, "&", tested_names2)
  }
}

get_ttestStats<- function(x, tested_kits) {
  c(t =format(x$statistic, digits = 2),
    df = format(x$parameter, digits = 0),
    p.value = format(x$p.value, scientific = TRUE, digits = 2),
    bonferroni.threshold = format(.05/length(test_names), digits = 2),
    sig = ifelse(x$p.value<(.05/length(test_names)), "yes", "no"))
}

#higher t is worse because we are using sds
get_test_results(data = data.frame(sdtest), test_names = test_names, pairedvalue = TRUE)
ttestStats_across<-data.frame(lapply(tresults, get_ttestStats, tested_kits = tested_kits))
colnames(ttestStats_across)<-tested_kits
ttestStats_across

#higher t is worse because we are using variance
get_test_results(data = data.frame(vartest), test_names = test_names, pairedvalue = TRUE)
ttestStats_across<-data.frame(lapply(tresults, get_ttestStats, tested_kits = tested_kits))
colnames(ttestStats_across)<-tested_kits
ttestStats_across

sdtest <-data.frame(sdtest)
sdtestm<-melt(sdtest)
ggplot(sdtestm, aes(x = variable, y = value))+geom_boxplot(notch =TRUE, aes(fill = variable), outlier.shape = NA, varwidth = TRUE)+geom_jitter(aes(color = variable, alpha = 0.5))

vartest <-data.frame(vartest)
vartestm<-melt(vartest)
ggplot(vartestm, aes(x = variable, y = value))+geom_boxplot(notch =TRUE, aes(fill = variable), outlier.shape = NA, varwidth = TRUE)+geom_jitter(aes(color = variable, alpha = 0.5))

#summary(lm(sdtest~colnames(sdtest)))
```

Standard Deviation Full
```{r}

#split_kit_thresh is all rows
logData<-lapply(split_kit_thresh, log2)
###need to just compare average of batch 1 to batch 2
logData$Clontech[2:4]<-rowMeans(logData$Clontech[2:4])
logData$Clontech[3:4] <-NULL
logData$Illumina[2:4]<-rowMeans(logData$Illumina[2:4])
logData$Illumina[3:4] <-NULL
logData$NEB[2:4]<-rowMeans(logData$NEB[2:4])
logData$NEB[3:4] <-NULL
logData$NEXTflex[2:4]<-rowMeans(logData$NEXTflex[2:4])
logData$NEXTflex[3:4] <-NULL
logData$Deduped[2:4]<-rowMeans(logData$Deduped[2:4])
logData$Deduped[3:4] <-NULL
logData$Fivepercent[2:4]<-rowMeans(logData$Fivepercent[2:4])
logData$Fivepercent[3:4] <-NULL

sdtest <- lapply(logData,rowSds)#genefilter
vartest <-lapply(logData,rowVars)



test_names <- data.frame(combn(names(logData), m= 2))

get_test_results<- function(data,test_names, pairedvalue) {
  tresults<<-list()
  tested_names1<<-list()
  tested_names2<<-list()
  for(i in names(test_names)){
    Kit1 <-data[which(names(data) %in% test_names[i][1,])]
    Kit2 <-data[which(names(data) %in% test_names[i][2,])]
    #Kit1<-data.frame(select(data, colnames(data)[colnames(data) %in% test_names[i][1,]]))
    #Kit2<-data.frame(select(data, colnames(data)[colnames(data) %in% test_names[i][2,]]))
    tested_names1[[i]]<<-names(data)[names(data) %in% test_names[i][1,]]
    tested_names2[[i]]<<-names(data)[names(data) %in% test_names[i][2,]]
    names(Kit1)<-c("error")
    names(Kit2)<-c("error")
    tresults[[i]]<<-t.test(x=Kit1[[1]], y=Kit2[[1]], paired = pairedvalue)
    tested_kits <<-paste0(tested_names1, "&", tested_names2)
  }
}

get_ttestStats<- function(x, tested_kits) {
  c(t =format(x$statistic, digits = 2),
    df = format(x$parameter, digits = 0),
    p.value = format(x$p.value, scientific = TRUE, digits = 2),
    bonferroni.threshold = format(.05/length(test_names), digits = 2),
    sig = ifelse(x$p.value<(.05/length(test_names)), "yes", "no"))
}

#higher t is worse because we are using sds
get_test_results(data = sdtest, test_names = test_names, pairedvalue = FALSE)
ttestStats_across<-data.frame(lapply(tresults, get_ttestStats, tested_kits = tested_kits))
colnames(ttestStats_across)<-tested_kits
ttestStats_across

#higher t is worse because we are using variance
get_test_results(data = vartest, test_names = test_names, pairedvalue = FALSE)
ttestStats_across<-data.frame(lapply(tresults, get_ttestStats, tested_kits = tested_kits))
colnames(ttestStats_across)<-tested_kits
ttestStats_across

sdtestm<-melt(sdtest)
sdtestm$L1<-factor(sdtestm$L1, levels = c("Clontech", "Illumina", "NEB", "NEXTflex", "Deduped", "Fivepercent"))

ggplot(sdtestm, aes(x = L1, y = value))+geom_boxplot(notch =TRUE, aes(fill = L1), outlier.shape = NA, varwidth = TRUE)+geom_jitter(aes(color = L1, alpha=0.5))


vartestm<-melt(vartest)
vartestm$L1<-factor(vartestm$L1, levels = c("Clontech", "Illumina", "NEB", "NEXTflex", "Deduped", "Fivepercent"))
ggplot(vartestm, aes(x = L1, y = value))+geom_boxplot(notch =TRUE, aes(fill = L1), outlier.shape = NA, varwidth = TRUE)+geom_jitter(aes(color = L1, alpha = 0.5))
#summary(lm(sdtest~colnames(sdtest)))
```