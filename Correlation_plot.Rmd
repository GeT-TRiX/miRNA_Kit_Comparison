---
title: "Correlationplot"
author: "Carrie Wright"
date: "6/18/2018"
output: html_document
---
---
title: "R Notebook"
output:
  html_document:
    df_print: paged
---

load the data
```{r, eval=TRUE, echo=FALSE}
library(here)
Pheno<- read.table(here("Complete_data/Pheno.txt"), header = TRUE)
miR_counts<-read.table(here("Complete_data/miR.Counts.csv"), header = TRUE, sep = ",")

rownames(miR_counts)<- miR_counts$miRNA#make miRNA rownames
miR_counts<-miR_counts[,2:length(colnames(miR_counts))]#remove miRNA col

colnames(miR_counts)<-gsub("directional_dedupped|directional_deduped", "Deduped", colnames(miR_counts))
colnames(miR_counts)<-gsub("NEXT_", "NEXTflex_", colnames(miR_counts))
miRNAtotal<-t(miR_counts[1,])#extract the total miRNA counts... in case we want them
miR_counts<-miR_counts[-1,]#remove total miRNA counts row

Pheno$File<-gsub("NEXTflex_deduped", "Deduped", Pheno$File)
Pheno$Kit<-gsub("NEXTflex_deduped", "Deduped", Pheno$Kit)
Pheno$TriplicateGroup<-gsub("NEXTflex_deduped", "Deduped", Pheno$TriplicateGroup)
Pheno$miRNAtotal <-miRNAtotal
 
identical(as.character(Pheno$File), colnames(data.frame(miR_counts))) ###Check that these match 
identical(rownames(miRNAtotal), Pheno$File)
#remove extra samples
Pheno<- Pheno[-2,]
miR_counts<- miR_counts[,-2]

#remove Fivepercent
#Pheno<- Pheno[1:81,]
#miR_counts<-miR_counts[,1:81]
#Pheno<- Pheno[-6,]
#miR_counts<-miR_counts[,-6]
# #remove Deduped
#   Pheno<- Pheno[1:62,]
# miR_counts<-miR_counts[,1:62]
# Pheno<- Pheno[-5,]
# miR_counts<-miR_counts[,-5]
miR_counts<- miR_counts[which(Pheno$startingAmt =="1000")]
Pheno <- Pheno[which(Pheno$startingAmt =="1000"),]#grab just the 1000ng samples
```

 
 

###DESeq2
```{r, eval=TRUE,warning=FALSE, message=FALSE, echo =FALSE}
library(DESeq2)
dds<-DESeqDataSetFromMatrix(countData = miR_counts, colData = Pheno, design = ~ Kit)
dds <- estimateSizeFactors(dds)
norm_miR_counts<-data.frame(counts(dds, normalized = TRUE))
dim(norm_miR_counts)
```

###genefilter
```{r, eval=TRUE, echo = FALSE}
library(genefilter)
#poverafun <- genefilter::pOverA(p = .5, A = 529)# at least 529 reads for 50% of samples
poverafun <- genefilter::pOverA(p = 1, A = 1)#at least one raw read in all samples #379
#poverafun <- genefilter::pOverA(p = 1, A = 10)#at least 10 raw reads in all samples #292
#poverafun <- genefilter::pOverA(p = 1, A = 100)#at least 100 raw reads in all samples #125

ffun <- filterfun(poverafun)
index <- genefilter(miR_counts, ffun)
thresh_miR_counts <- miR_counts[index,] # CHANGE TO NORM MIR COUNTS!!!
dim(thresh_miR_counts)
```

###correlationplot
```{r, eval = TRUE}
library(GGally)
set.seed(42)
thresh_miR_counts <-sapply(thresh_miR_counts, log2)
thresh_miR_counts<-data.frame(thresh_miR_counts)
# make average for miR_Counts by kit
split_kit <- list() 
for(i in Pheno$Kit) { 
  split_kit[[i]] <- data.frame(thresh_miR_counts[which(Pheno$Kit==i)]) #raw counts
} 

avg_1000ng <-lapply(split_kit,rowMeans)
avg_1000ng<-data.frame(avg_1000ng)
# avg_1000ng<-sapply(avg_1000ng, log2)
# avg_1000ng<- data.frame(avg_1000ng)
ggpairs(avg_1000ng)
# estimated density in diagonal
```
###Dendrogram to see how data clusters after normalization of counts
```{r, echo=FALSE, message=FALSE, warning=FALSE, eval=TRUE}
library(rafalib)
library(dendextend)
library(reshape2)

#thresh_miR_1000 <-  finding_rows(norm_miR_1000) could do this if we decide we need to be consistent with later analyses - but not much diff



yGene <-as.matrix(thresh_miR_counts)
miRNAc <- hclust(dist(t(yGene)))
pdD<-Pheno
pdD$Kit<-as.factor(pdD$Kit)
pdD$TriplicateGroup<-as.factor(pdD$TriplicateGroup)
par(mar=c(10,2,3,0))
colors<-as.numeric(pdD$Kit)

gg_color_hue <- function(n) {
  hues = seq(15, 375, length = n + 1)
  hcl(h = hues, l = 65, c = 100)[1:n]
}

n = 6
cols = gg_color_hue(n)
repeat_colors <-function(x){rep(x,6)}
cols2 <- lapply(cols, repeat_colors)
cols2<-unlist(cols2)
cols2 <-cols2[order(miRNAc$order)]

myplclust(miRNAc, labels=pdD$TriplicateGroup,lab.col=(cols2), main = "Counts cluster by library prep kit")

```


