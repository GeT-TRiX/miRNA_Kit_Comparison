---
title: "Correlationplot"
author: "Carrie Wright"
date: "6/18/2018"
output: html_document
---
---
title: "R Notebook"
output:
  html_document:
    df_print: paged
---

load the data
```{r, eval=TRUE, echo=FALSE}
library(here)
Pheno<- read.table(here("Complete_data/Pheno.txt"), header = TRUE)
miR_counts<-read.table(here("Complete_data/miR.Counts.csv"), header = TRUE, sep = ",")

rownames(miR_counts)<- miR_counts$miRNA#make miRNA rownames
miR_counts<-miR_counts[,2:length(colnames(miR_counts))]#remove miRNA col

colnames(miR_counts)<-gsub("directional_dedupped|directional_deduped", "Deduped", colnames(miR_counts))
colnames(miR_counts)<-gsub("NEXT_", "NEXTflex_", colnames(miR_counts))
miRNAtotal<-t(miR_counts[1,])#extract the total miRNA counts... in case we want them
miR_counts<-miR_counts[-1,]#remove total miRNA counts row

Pheno$File<-gsub("NEXTflex_deduped", "Deduped", Pheno$File)
Pheno$Kit<-gsub("NEXTflex_deduped", "Deduped", Pheno$Kit)
Pheno$TriplicateGroup<-gsub("NEXTflex_deduped", "Deduped", Pheno$TriplicateGroup)
Pheno$miRNAtotal <-miRNAtotal
 
identical(as.character(Pheno$File), colnames(data.frame(miR_counts))) ###Check that these match 
identical(rownames(miRNAtotal), Pheno$File)
#remove extra samples
Pheno<- Pheno[-2,]
miR_counts<- miR_counts[,-2]

#remove Fivepercent
#Pheno<- Pheno[1:81,]
#miR_counts<-miR_counts[,1:81]
#Pheno<- Pheno[-6,]
#miR_counts<-miR_counts[,-6]
# #remove Deduped
#   Pheno<- Pheno[1:62,]
# miR_counts<-miR_counts[,1:62]
# Pheno<- Pheno[-5,]
# miR_counts<-miR_counts[,-5]
miR_counts<- miR_counts[which(Pheno$startingAmt =="1000")]
Pheno <- Pheno[which(Pheno$startingAmt =="1000"),]#grab just the 1000ng samples
```

 
 

###DESeq2
```{r, eval=TRUE,warning=FALSE, message=FALSE, echo =FALSE}
library(DESeq2)
dds<-DESeqDataSetFromMatrix(countData = miR_counts, colData = Pheno, design = ~ Kit)
dds <- estimateSizeFactors(dds)
norm_miR_counts<-data.frame(counts(dds, normalized = TRUE))
dim(norm_miR_counts)
```

###genefilter
```{r, eval=TRUE, echo = FALSE}
library(genefilter)
#poverafun <- genefilter::pOverA(p = .5, A = 529)# at least 529 reads for 50% of samples
poverafun <- genefilter::pOverA(p = 1, A = 1)#at least one raw read in all samples #379
#poverafun <- genefilter::pOverA(p = 1, A = 10)#at least 10 raw reads in all samples #292
#poverafun <- genefilter::pOverA(p = 1, A = 100)#at least 100 raw reads in all samples #125

ffun <- filterfun(poverafun)
index <- genefilter(miR_counts, ffun)
thresh_miR_counts <- miR_counts[index,] # CHANGE TO NORM MIR COUNTS!!!
dim(thresh_miR_counts)
```





###correlationplot
```{r, eval = TRUE}
library(GGally)
set.seed(42)
thresh_miR_counts <-sapply(thresh_miR_counts, log2)
thresh_miR_counts<-data.frame(thresh_miR_counts)
# make average for miR_Counts by kit
split_kit <- list() 
for(i in Pheno$Kit) { 
  split_kit[[i]] <- data.frame(thresh_miR_counts[which(Pheno$Kit==i)]) #raw counts
} 

avg_1000ng <-lapply(split_kit,rowMeans)
avg_1000ng<-data.frame(avg_1000ng)
# avg_1000ng<-sapply(avg_1000ng, log2)
# avg_1000ng<- data.frame(avg_1000ng)
pdf(file =here("Figures/Raw_plots/Fig.2.c.pdf"),width=10.5,height=7)
ggpairs(avg_1000ng)
dev.off()
# estimated density in diagonal
```

##MA plot
```{r}
library(limma)
#NEBvsNEXT
lm(avg_1000ng$Clontech, avg_1000ng$NEB)
plotMA(object = thresh_miR_counts)#plotMA expects the data frame to have 3 columns, two numeric ones for mean and log fold change, and a logical one for significance

library(edgeR)
#matrix(avg_1000ng$Clontech, avg_1000ng$NEB, ncol =2)

maPlot(x =avg_1000ng$Clontech, y =avg_1000ng$NEB,lowess = TRUE) 
maPlot(x =avg_1000ng$Clontech, y =avg_1000ng$NEXTflex,lowess = TRUE )
maPlot(x =avg_1000ng$Clontech, y =avg_1000ng$Illumina,lowess = TRUE )
maPlot(x =avg_1000ng$Clontech, y =avg_1000ng$Deduped,lowess = TRUE )
maPlot(x =avg_1000ng$Clontech, y =avg_1000ng$Fivepercent,lowess = TRUE )
maPlot(x =avg_1000ng$NEB, y =avg_1000ng$Illumina ,lowess = TRUE)
maPlot(x =avg_1000ng$NEB, y =avg_1000ng$NEXTflex ,lowess = TRUE)
maPlot(x =avg_1000ng$NEB, y =avg_1000ng$Deduped ,lowess = TRUE)
maPlot(x =avg_1000ng$NEB, y =avg_1000ng$Fivepercent ,lowess = TRUE)

maPlot(x =avg_1000ng$NEXTflex, y =avg_1000ng$Illumina ,lowess = TRUE)
maPlot(x =avg_1000ng$NEXTflex, y =avg_1000ng$Deduped ,lowess = TRUE)
maPlot(x =avg_1000ng$NEXTflex, y =avg_1000ng$Fivepercent ,lowess = TRUE)
maPlot(x =avg_1000ng$Deduped, y =avg_1000ng$Fivepercent ,lowess = TRUE)

data_1000ng<-as.matrix(avg_1000ng)
 maPlot(data_1000ng[,3], data_1000ng[,3], lowess = TRUE)
#example...
y <- matrix(rnbinom(10000,mu=5,size=2),ncol=4)
 maPlot(y[,3], y[,4], lowess = TRUE)
library(affy)
ma.plot( rowMeans((avg_1000ng[c(1,3)])), (avg_1000ng$Clontech)-(avg_1000ng$NEB), cex=1 )


##another example
ggplot(df, aes(x = A, y = M)) + geom_point(size = 1.5, alpha = 1/5) +
geom_hline(color = "blue3") + stat_smooth(se = FALSE, method = "loess", color = "red3")



#with Limma
A <- runif(1000,4,16)
y <- A + matrix(rnorm(1000*3,sd=0.2),1000,3)
status <- rep(c(0,-1,1),c(950,40,10))
y[,1] <- y[,1] + status
limma::plotMA(y, array=1, status=status, values=c(-1,1), hl.col=c("blue","red"))

##### manually
x = data_1000ng[, 1]#clontech
y = data_1000ng[, 2]#Illumina
M = x - y
A = (x + y)/2
df = data.frame(A, M)
ggplot(df, aes(x = A, y = M)) + geom_point(size = 1.5, alpha = 1/5)+ stat_smooth(se = FALSE, method = "loess", color = "red3")

x = data_1000ng[, 1]#clontech
y = data_1000ng[, 3]#NEB
M = x - y
A = (x + y)/2
df = data.frame(A, M)
ggplot(df, aes(x = A, y = M)) + geom_point(size = 1.5, alpha = 1/5)+ stat_smooth(se = FALSE, method = "loess", color = "red3")

x = data_1000ng[, 1]#clontech
y = data_1000ng[, 4]#NEXTflex
M = x - y
A = (x + y)/2
df = data.frame(A, M)
ggplot(df, aes(x = A, y = M)) + geom_point(size = 1.5, alpha = 1/5)+ stat_smooth(se = FALSE, method = "loess", color = "red3")


x = data_1000ng[, 1]#Clontech
y = data_1000ng[, 5]#Deduped
M = x - y
A = (x + y)/2
df = data.frame(A, M)
ggplot(df, aes(x = A, y = M)) + geom_point(size = 1.5, alpha = 1/5)+ stat_smooth(se = FALSE, method = "loess", color = "red3")


x = data_1000ng[, 1]#Clontech
y = data_1000ng[, 6]#Fivepercent
M = x - y
A = (x + y)/2
df = data.frame(A, M)
ggplot(df, aes(x = A, y = M)) + geom_point(size = 1.5, alpha = 1/5)+ stat_smooth(se = FALSE, method = "loess", color = "red3")

x = data_1000ng[, 5]#Deduped
y = data_1000ng[, 6]#Fivepercent
M = x - y
A = (x + y)/2
df = data.frame(A, M)
ggplot(df, aes(x = A, y = M)) + geom_point(size = 1.5, alpha = 1/5)+ stat_smooth(se = FALSE, method = "loess", color = "red3")

x = data_1000ng[, 4]#NEXTflex
y = data_1000ng[, 5]#Deduped
M = x - y
A = (x + y)/2
df = data.frame(A, M)
ggplot(df, aes(x = A, y = M)) + geom_point(size = 1.5, alpha = 1/5)+ stat_smooth(se = FALSE, method = "loess", color = "red3")

x = data_1000ng[, 4]#NEXTflex
y = data_1000ng[, 6]#Fivepercent
M = x - y
A = (x + y)/2
df = data.frame(A, M)
ggplot(df, aes(x = A, y = M)) + geom_point(size = 1.5, alpha = 1/5)+ stat_smooth(se = FALSE, method = "loess", color = "red3")

```

###Dendrogram to see how data clusters after normalization of counts
```{r, echo=FALSE, message=FALSE, warning=FALSE, eval=TRUE}
library(rafalib)
library(dendextend)
library(reshape2)

#thresh_miR_1000 <-  finding_rows(norm_miR_1000) could do this if we decide we need to be consistent with later analyses - but not much diff



yGene <-as.matrix(thresh_miR_counts)
miRNAc <- hclust(dist(t(yGene)))
pdD<-Pheno
pdD$Kit<-as.factor(pdD$Kit)
pdD$TriplicateGroup<-as.factor(pdD$TriplicateGroup)
par(mar=c(10,2,3,0))
colors<-as.numeric(pdD$Kit)

gg_color_hue <- function(n) {
  hues = seq(15, 375, length = n + 1)
  hcl(h = hues, l = 65, c = 100)[1:n]
}

n = 6
cols = gg_color_hue(n)
repeat_colors <-function(x){rep(x,6)}
cols2 <- lapply(cols, repeat_colors)
cols2<-unlist(cols2)
cols2 <-cols2[order(miRNAc$order)]

myplclust(miRNAc, labels=pdD$TriplicateGroup,lab.col=(cols2), main = "Counts cluster by library prep kit")

```


